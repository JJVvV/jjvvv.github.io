<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="Regularjs是网易开源的 mvvm 框架，今天就以 Regularjs 为例阅读源码片段，便于更好的理解脏检测双向绑定的原理。"><meta name="keywords" content="regularjs,源码"><meta property="og:type" content="article"><meta property="og:title" content="Regular(MVVM)源码分析"><meta property="og:url" content="https://jjvvv.github.io/2017/07/28/Regular(MVVM)源码分析/index.html"><meta property="og:site_name" content="Alex"><meta property="og:description" content="Regularjs是网易开源的 mvvm 框架，今天就以 Regularjs 为例阅读源码片段，便于更好的理解脏检测双向绑定的原理。"><meta property="og:locale" content="default"><meta property="og:updated_time" content="2019-04-22T10:55:43.610Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Regular(MVVM)源码分析"><meta name="twitter:description" content="Regularjs是网易开源的 mvvm 框架，今天就以 Regularjs 为例阅读源码片段，便于更好的理解脏检测双向绑定的原理。"><link rel="shortcut icon" href="/images/avatar_s.png"><link rel="icon" type="image/png" href="/images/avatar_s.png" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/avatar_s.png"><title>Regular(MVVM)源码分析</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/rtl.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css"></head><body class="max-width mx-auto px3 ltr"><div id="header-post"><a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a><a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a><a id="top-icon-tablet" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fas fa-chevron-up fa-lg"></i></a><span id="menu"><span id="nav"><ul><li> <a href="/">Home</a></li><li> <a href="/about/">About</a></li><li> <a href="/archives/">Writing</a></li><li> <a href="/tags/">Tag</a></li><li> <a href="/categories/">Categories</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="/2017/09/06/消除代码块中繁杂的if else/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class="icon" href="/2017/07/12/实现自己的virtual-dom/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fas fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul> <span id="i-prev" class="info" style="display:none">Previous post</span> <span id="i-next" class="info" style="display:none">Next post</span> <span id="i-top" class="info" style="display:none">Back to top</span> <span id="i-share" class="info" style="display:none">Share post</span></span><br><div id="share" style="display:none"><ul><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://jjvvv.github.io/2017/07/28/Regular(MVVM)源码分析/"><i class="fab fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https://jjvvv.github.io/2017/07/28/Regular(MVVM)源码分析/&text=Regular(MVVM)源码分析"><i class="fab fa-twitter" aria-hidden="true"></i></a></li></ul></div><div id="toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#实例"><span class="toc-number">1.</span> <span class="toc-text">实例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模板编译"><span class="toc-number">2.</span> <span class="toc-text">模板编译</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#update-方法"><span class="toc-number">3.</span> <span class="toc-text">\$update 方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#digest-方法"><span class="toc-number">4.</span> <span class="toc-text">\$digest 方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#digest-方法-1"><span class="toc-number">5.</span> <span class="toc-text">_digest 方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#处理-if-else"><span class="toc-number">6.</span> <span class="toc-text">处理 if else</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#compile-方法"><span class="toc-number">7.</span> <span class="toc-text">\$compile 方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#walk-方法"><span class="toc-number">8.</span> <span class="toc-text">_walk 方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">9.</span> <span class="toc-text">总结</span></a></li></ol></div></span></div><div class="content index py4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline"> Regular(MVVM)源码分析</h1><div class="meta"> <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Alex</span></span><div class="postdate"> <time datetime="2017-07-28T06:02:59.000Z" itemprop="datePublished">2017-07-28</time></div><div class="article-category"><i class="fas fa-archive"></i> <a class="category-link" href="/categories/FrontEnd/">FrontEnd</a></div><div class="article-tag"><i class="fas fa-tag"></i> <a class="tag-link" href="/tags/regularjs/">regularjs</a>, <a class="tag-link" href="/tags/源码/">源码</a></div></div></header><div class="content" itemprop="articleBody"><p><a href="https://github.com/regularjs/regular/" target="_blank" rel="noopener">Regularjs</a>是网易开源的 mvvm 框架，今天就以 Regularjs 为例阅读源码片段，便于更好的理解脏检测双向绑定的原理。</p><a id="more"></a><h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"wrapper"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Button = Regular.extend(&#123;</span><br><span class="line">  name: <span class="string">"UIButton"</span>,</span><br><span class="line">  template:</span><br><span class="line">    <span class="string">"&lt;button on-click=&#123;this.click()&#125;&gt;&#123; #if flag&#125;&lt;span&gt;&#123;label&#125;&lt;/span&gt;&#123; #else&#125;no&#123;/if&#125;&lt;/button&gt;"</span>,</span><br><span class="line">  click: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">debugger</span>;</span><br><span class="line">    <span class="keyword">this</span>.data.flag = !<span class="keyword">this</span>.data.flag;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> TestUI = Regular.extend(&#123;</span><br><span class="line">  template:</span><br><span class="line">    <span class="string">'&lt;div style="margin: 100px"&gt;&#123;value&#125;&lt;UIButton label="button"&gt;&lt;/UIButton&gt;&lt;/div&gt;'</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">new</span> TestUI(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    label: <span class="string">"button show"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;).$inject(<span class="string">"#wrapper"</span>);</span><br></pre></td></tr></table></figure><h2 id="模板编译"><a href="#模板编译" class="headerlink" title="模板编译"></a>模板编译</h2><p>模板编译应该是 Regular 中最复杂的代码了，但功能很单一，就是将一段 html 文本转换为相应的对象。</p><p>模板在编译时会生成以下几类元素对象：</p><ul><li>attribute （nodeType==2 类型）</li><li>component （自定义组件类型）</li><li>element （nodeType==1 类型）</li><li>expression（{label}类型）</li><li>if （{ #if}{ #else}类型）</li><li>list （{ #list}循环类型）</li><li>text （nodeType==3 类型）</li></ul><p>在本例中，一共定义了两个 Regular 类，TestUI 的模板中引用到了 Button 类。<br>在实例化 TestUI 的时候会先编译模板，将</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"margin: 100px"</span>&gt;</span></span><br><span class="line">  &#123;value&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">UIButton</span> <span class="attr">label</span>=<span class="string">"button"</span>&gt;</span><span class="tag">&lt;/<span class="name">UIButton</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>转化为对象构成数结构的对象：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> vdom = [</span><br><span class="line">  &#123;</span><br><span class="line">    attrs: [&#123; <span class="attr">name</span>: <span class="string">"style"</span>, <span class="attr">type</span>: <span class="string">"attribute"</span>, <span class="attr">value</span>: <span class="string">"margin:100px"</span> &#125;],</span><br><span class="line">    children: [</span><br><span class="line">      &#123;</span><br><span class="line">        body: <span class="string">"c._sg_('value', d, e)"</span>,</span><br><span class="line">        constant: <span class="literal">false</span>,</span><br><span class="line">        setbody: <span class="string">"c._ss_('value',p_,d, '=', 1)"</span>,</span><br><span class="line">        type: <span class="string">"expression"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        type: <span class="string">"element"</span>,</span><br><span class="line">        tag: <span class="string">"UIButton"</span>,</span><br><span class="line">        attrs: [&#123; <span class="attr">type</span>: <span class="string">"attribute"</span>, <span class="attr">name</span>: <span class="string">"label"</span>, <span class="attr">value</span>: <span class="string">"button"</span> &#125;],</span><br><span class="line">        children: []</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    tag: <span class="string">"div"</span>,</span><br><span class="line">    type: <span class="string">"element"</span></span><br><span class="line">  &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure><p>walkers.expression 方法用来处理模板中的{value}， 会生成一个 textNode，并\$watch，<br>这段代码就揭示了双向绑定的原理，当值变化时更新 dom。也可以看出来这种更新是很细粒度的。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">walkers.expression = <span class="function"><span class="keyword">function</span>(<span class="params">ast, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> node = <span class="built_in">document</span>.createTextNode(<span class="string">""</span>);</span><br><span class="line">  <span class="keyword">this</span>.$watch(</span><br><span class="line">    ast,</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">newval</span>) </span>&#123;</span><br><span class="line">      dom.text(node, <span class="string">""</span> + (newval == <span class="literal">null</span> ? <span class="string">""</span> : <span class="string">""</span> + newval));</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="attr">init</span>: <span class="literal">true</span> &#125;</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> node;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>\$watch 方法会 push 一个 watch 对象到 this._watchers 数组中，用于日后统一更新。<br>然后执行_checkSingleWatch 方法，如果 now 与 last 值不等则 dirty=true 进行 watch 更新 dom。</p><p>walkers.element 方法用来处理模板中的标签元素和自定义组件，如本例中的 div、UIButton</p><p>当生成一个 Regular 类并带有 name 属性的时候会保存在 Regular._components 对象上。如果在模板中匹配到类的 name 则使用类进行标签初始化。</p><p>walkers.component 在 walkers.element 中进行调用，此方法中会进行自定义组件的 data 初始化:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data[<span class="string">"label"</span>] = <span class="string">"button"</span>;</span><br></pre></td></tr></table></figure><p>然后会 new 一个 UIButton 实例，并且会保存进$parent._children数组中，用于后续操作，本例中$parent 为 TestUI 的实例</p><p>walkers[‘if’]处理模板中的 if else.</p><p>walkers.text 方法用于处理正常的字符串</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">walkers.text = <span class="function"><span class="keyword">function</span>(<span class="params">ast, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> node = <span class="built_in">document</span>.createTextNode(_.convertEntity(ast.text));</span><br><span class="line">  <span class="keyword">return</span> node;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="update-方法"><a href="#update-方法" class="headerlink" title="\$update 方法"></a>\$update 方法</h2><p>this.\$update 方法会找到最外层组件进行更新，所以不管是哪一层的子组件更新，都会“冒泡”到最上层组件进行更新检测。当然 Regular 提供了 data.isolate 用来阻止组件向上“冒泡”</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$update: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	    <span class="keyword">var</span> rootParent = <span class="keyword">this</span>;</span><br><span class="line">	    <span class="keyword">do</span>&#123;</span><br><span class="line">	      <span class="keyword">if</span>(rootParent.data.isolate || !rootParent.$parent) <span class="keyword">break</span>;</span><br><span class="line">	      rootParent = rootParent.$parent;</span><br><span class="line">	    &#125; <span class="keyword">while</span>(rootParent)</span><br><span class="line"></span><br><span class="line">	    <span class="keyword">var</span> prephase =rootParent.$phase;</span><br><span class="line">	    rootParent.$phase = <span class="string">'digest'</span></span><br><span class="line"></span><br><span class="line">	    <span class="keyword">this</span>.$<span class="keyword">set</span>.apply(this, arguments);</span><br><span class="line"></span><br><span class="line">	    rootParent.$phase = prephase</span><br><span class="line"></span><br><span class="line">	    rootParent.$digest();</span><br><span class="line">	    return this;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="digest-方法"><a href="#digest-方法" class="headerlink" title="\$digest 方法"></a>\$digest 方法</h2><p>当 dom 都渲染好了之后如何更新 dom 呢？this.$update()方法中会调用$digest 方法，\$digest 会进行脏检测。</p><p>$digest方法中会进行$phase 判断，如果正在脏检测则直接 return，所以在$update的回调函数（如regular提供的事件函数）中调用$update 方法是无效操作，这样有利于避免频繁的无用的更新操作。<br>$digest方法里有一个while循环，如果循环20次以上则认为出了问题并抛错。在进行$digest 时，只要有任何的组件 dirty=true 都会再进入循环，直到所有组件 dirty=false。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$digest: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.$phase === <span class="string">'digest'</span> || <span class="keyword">this</span>._mute) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">this</span>.$phase = <span class="string">'digest'</span>;</span><br><span class="line">    <span class="keyword">var</span> dirty = <span class="literal">false</span>, n =<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(dirty = <span class="keyword">this</span>._digest())&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>((++n) &gt; <span class="number">20</span>)&#123; <span class="comment">// max loop</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">Error</span>(<span class="string">'there may a circular dependencies reaches'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( n &gt; <span class="number">0</span> &amp;&amp; <span class="keyword">this</span>.$emit) &#123;</span><br><span class="line">      <span class="keyword">this</span>.$emit(<span class="string">"$update"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.$phase = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="digest-方法-1"><a href="#digest-方法-1" class="headerlink" title="_digest 方法"></a>_digest 方法</h2><p>一个组件是否 dirty 和两个因素有关：</p><ol><li>组件所有监听的数据是否 dirty（组件本身的监听的变量是否 dirty）</li><li>组件所有的子组件是否 dirty（组件包含的子组件是否 dirty）</li></ol><p>组件本身监听函数保存在 this._watchers 数组中，组件的子组件实例保存在 this.children 数组中。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">_digest: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> watchers = <span class="keyword">this</span>._watchers;</span><br><span class="line">    <span class="keyword">var</span> dirty = <span class="literal">false</span>, children, watcher, watcherDirty;</span><br><span class="line">    <span class="keyword">var</span> len = watchers &amp;&amp; watchers.length;</span><br><span class="line">    <span class="keyword">if</span>(len)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">var</span> i =<span class="number">0</span>; i &lt; len; i++ )&#123;</span><br><span class="line">        watcher = watchers[i];</span><br><span class="line">        <span class="keyword">if</span>( !watcher ||  watcher.removed )&#123;</span><br><span class="line">          watchers.splice( i--, <span class="number">1</span> );</span><br><span class="line">          len--;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          watcherDirty = <span class="keyword">this</span>._checkSingleWatch(watcher, i);</span><br><span class="line">          <span class="keyword">if</span>(watcherDirty) dirty = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// check children's dirty.</span></span><br><span class="line">    children = <span class="keyword">this</span>._children;</span><br><span class="line">    <span class="keyword">if</span>(children &amp;&amp; children.length)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">var</span> m = <span class="number">0</span>, mlen = children.length; m &lt; mlen; m++)&#123;</span><br><span class="line">        <span class="keyword">var</span> child = children[m];</span><br><span class="line">        <span class="keyword">if</span>(child &amp;&amp; child._digest()) dirty = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dirty;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h2 id="处理-if-else"><a href="#处理-if-else" class="headerlink" title="处理 if else"></a>处理 if else</h2><p>Regular 会将 if else 模板的值保存在 group 数组中，并为 flag 变量注册一个 watcher，当 flag 变化的时候，先删除掉之前保存在 group 中的 dom，然后生成新的 dom 并保存在 goup 中。</p><p>处理 if else 的时候要解决 unwatch 的问题。在本例中，{ #if flag}值为 true 的时候会多注册一个{label}的 express 监听。当 flag==false 的时候，这个监听就没用了，所以这个时候要 unwatch 掉这个监听。</p><p>Regular 是如何做到的呢？Regualr 在注册对 flag 的监听函数的回调函数中（下边的 update）调用\$compile 方法，此方法会根据 if else 中夹杂的模板生成相应的 dom。</p><ul><li>flag = true —&gt; &lt;span&gt;{label}&lt;/span&gt;</li><li>flag = false —&gt; no</li></ul><p>此方法的第二个参数{record:true}的意思是说：哦，我要收集一下这个模板里的所有 watcher，日后用于删除哦！</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//&#123; #if flag&#125;监听函数的回调函数中, flag变化时触发</span></span><br><span class="line"><span class="keyword">var</span> update = <span class="function"><span class="keyword">function</span>(<span class="params">nvalue, old</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> value = !!nvalue;</span><br><span class="line">  <span class="keyword">if</span> (value === preValue) <span class="keyword">return</span>;</span><br><span class="line">  preValue = value;</span><br><span class="line">  <span class="keyword">if</span> (group.children[<span class="number">1</span>]) &#123;</span><br><span class="line">    group.children[<span class="number">1</span>].destroy(<span class="literal">true</span>);</span><br><span class="line">    group.children.pop();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (value) &#123;</span><br><span class="line">    <span class="comment">//true</span></span><br><span class="line">    <span class="keyword">if</span> (ast.consequent &amp;&amp; ast.consequent.length) &#123;</span><br><span class="line">      consequent = self.$compile(ast.consequent, &#123;</span><br><span class="line">        record: <span class="literal">true</span>,</span><br><span class="line">        outer: options.outer,</span><br><span class="line">        namespace: namespace,</span><br><span class="line">        extra: extra</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="comment">// placeholder.parentNode &amp;&amp; placeholder.parentNode.insertBefore( node, placeholder );</span></span><br><span class="line">      group.push(consequent);</span><br><span class="line">      <span class="keyword">if</span> (placeholder.parentNode) &#123;</span><br><span class="line">        animate.inject(combine.node(consequent), placeholder, <span class="string">"before"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//false</span></span><br><span class="line">    <span class="keyword">if</span> (ast.alternate &amp;&amp; ast.alternate.length) &#123;</span><br><span class="line">      alternate = self.$compile(ast.alternate, &#123;</span><br><span class="line">        record: <span class="literal">true</span>,</span><br><span class="line">        outer: options.outer,</span><br><span class="line">        namespace: namespace,</span><br><span class="line">        extra: extra</span><br><span class="line">      &#125;);</span><br><span class="line">      group.push(alternate);</span><br><span class="line">      <span class="keyword">if</span> (placeholder.parentNode) &#123;</span><br><span class="line">        animate.inject(combine.node(alternate), placeholder, <span class="string">"before"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="compile-方法"><a href="#compile-方法" class="headerlink" title="\$compile 方法"></a>\$compile 方法</h2><p>\$compile 方法用于生成 dom 元素，第一个参数为编译好的 html 模板对象（本例中的 vdom）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$compile: <span class="function"><span class="keyword">function</span>(<span class="params">ast, options</span>)</span>&#123;</span><br><span class="line">    options = options || &#123;&#125;;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> ast === <span class="string">'string'</span>)&#123;</span><br><span class="line">      ast = <span class="keyword">new</span> Parser(ast).parse()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> preExt = <span class="keyword">this</span>.__ext__,</span><br><span class="line">      record = options.record,</span><br><span class="line">      records;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(options.extra) <span class="keyword">this</span>.__ext__ = options.extra;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//用于记录是否需要记录watcher，用于if else的watcher销毁</span></span><br><span class="line">    <span class="keyword">if</span>(record) <span class="keyword">this</span>._record();</span><br><span class="line">    <span class="comment">//遍历整个vdom数用于生成真实的dom树</span></span><br><span class="line">    <span class="keyword">var</span> group = <span class="keyword">this</span>._walk(ast, options);</span><br><span class="line">    <span class="keyword">if</span>(record)&#123;</span><br><span class="line">      records = <span class="keyword">this</span>._release();</span><br><span class="line">      <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">      <span class="keyword">if</span>(records.length)&#123;</span><br><span class="line">        <span class="comment">// auto destroy all wather;</span></span><br><span class="line">        group.ondestroy = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; self.$unwatch(records); &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(options.extra) <span class="keyword">this</span>.__ext__ = preExt;</span><br><span class="line">    <span class="keyword">return</span> group;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h2 id="walk-方法"><a href="#walk-方法" class="headerlink" title="_walk 方法"></a>_walk 方法</h2><p>_walk 方法会遍历 html 树结构的对象，根据不同的元素类型生成对应的 dom 元素。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">_walk: <span class="function"><span class="keyword">function</span>(<span class="params">ast, arg1</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>( _.typeOf(ast) === <span class="string">'array'</span> )&#123;</span><br><span class="line">      <span class="keyword">var</span> res = [];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>, len = ast.length; i &lt; len; i++)&#123;</span><br><span class="line">        res.push( <span class="keyword">this</span>._walk(ast[i], arg1) );</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Group(res);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> ast === <span class="string">'string'</span>) <span class="keyword">return</span> doc.createTextNode(ast)</span><br><span class="line">    <span class="keyword">return</span> walkers[ast.type || <span class="string">"default"</span>].call(<span class="keyword">this</span>, ast, arg1);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上为 Regular 中较为重要的一些方法，日后会再做补充。</p></div></article><div class="blog-post-comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the comments.</noscript></div></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul><li> <a href="/">Home</a></li><li> <a href="/about/">About</a></li><li> <a href="/archives/">Writing</a></li><li> <a href="/tags/">Tag</a></li><li> <a href="/categories/">Categories</a></li></ul></div><div id="toc-footer" style="display:none"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#实例"><span class="toc-number">1.</span> <span class="toc-text">实例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模板编译"><span class="toc-number">2.</span> <span class="toc-text">模板编译</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#update-方法"><span class="toc-number">3.</span> <span class="toc-text">\$update 方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#digest-方法"><span class="toc-number">4.</span> <span class="toc-text">\$digest 方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#digest-方法-1"><span class="toc-number">5.</span> <span class="toc-text">_digest 方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#处理-if-else"><span class="toc-number">6.</span> <span class="toc-text">处理 if else</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#compile-方法"><span class="toc-number">7.</span> <span class="toc-text">\$compile 方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#walk-方法"><span class="toc-number">8.</span> <span class="toc-text">_walk 方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">9.</span> <span class="toc-text">总结</span></a></li></ol></div><div id="share-footer" style="display:none"><ul><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://jjvvv.github.io/2017/07/28/Regular(MVVM)源码分析/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https://jjvvv.github.io/2017/07/28/Regular(MVVM)源码分析/&text=Regular(MVVM)源码分析"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="menu" class="icon" href="#" onclick='return $("#nav-footer").toggle(),!1'><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a><a id="toc" class="icon" href="#" onclick='return $("#toc-footer").toggle(),!1'><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a><a id="top" style="display:none" class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></div></div></div><footer id="footer"><div class="footer-left"> Copyright &copy; 2019 Alex Liu</div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/about/">About</a></li><li><a href="/archives/">Writing</a></li><li><a href="/tags/">Tag</a></li><li><a href="/categories/">Categories</a></li></ul></nav></div></footer></div><script src="/lib/jquery/jquery.min.js"></script><script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script><script src="/js/main.js"></script><script type="text/javascript">var disqus_shortname="jjvvv";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script></body></html>